<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Step 3 - Select & Refine Formative Tasks</title>
  <style>
    /* Same styles as before */
    body {
      margin: 0;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: linear-gradient(145deg, #0f172a, #1e293b);
      color: white;
      padding: 20px;
      min-height: 100vh;
      display: flex;
      justify-content: center;
      align-items: flex-start;
    }
    .container {
      max-width: 900px;
      width: 100%;
      background: rgba(255, 255, 255, 0.05);
      border: 1px solid rgba(255, 255, 255, 0.15);
      border-radius: 20px;
      padding: 30px;
      box-shadow: 0 0 30px rgba(0, 255, 255, 0.1);
      backdrop-filter: blur(10px);
    }
    h1 {
      text-align: center;
      color: #67e8f9;
      font-size: 2.2rem;
      margin-bottom: 10px;
    }
    p.description {
      text-align: center;
      color: #a5f3fc;
      margin-bottom: 20px;
      font-weight: 500;
      font-size: 1rem;
    }
    .warning {
      text-align: center;
      color: #facc15;
      font-weight: 600;
      margin-bottom: 15px;
    }

    /* Cards grid */
    .cards-grid {
      display: grid;
      grid-template-columns: repeat(2, 1fr); /* Changed to a fixed 2-column layout */
      gap: 20px;
      margin-bottom: 30px;
    }
    /* Card styling */
    .card {
      background: rgba(255, 255, 255, 0.07);
      border: 2px solid #38bdf8;
      border-radius: 16px;
      padding: 20px;
      box-shadow: 0 0 15px rgba(6, 182, 212, 0.1);
      cursor: pointer;
      transition: all 0.25s ease;
      display: flex;
      flex-direction: column;
      justify-content: space-between;
      min-height: 230px;
      position: relative;
    }
    .card:hover {
      background: rgba(255, 255, 255, 0.12);
      box-shadow: 0 0 25px rgba(6, 182, 212, 0.3);
      border-color: #06b6d4;
    }
    .card.selected {
      border-color: #06b6d4;
      box-shadow: 0 0 35px #06b6d4;
      background: rgba(6, 182, 212, 0.15);
    }

    /* Label styles with subtle colors */
    .card-label {
      font-size: 0.85rem;
      font-weight: 600;
      text-transform: uppercase;
      opacity: 0.75;
      margin-bottom: 8px;
      padding: 2px 8px;
      border-radius: 12px;
      width: fit-content;
      user-select: none;
    }
    /* Color-coded labels */
    .Linguistic { background-color: #a78bfa; color: #1e1b4b; }
    .Logical-mathematical { background-color: #f97316; color: #4b2a00; }
    .Spatial { background-color: #3b82f6; color: #0b2447; }
    .Musical { background-color: #ef4444; color: #4b1c1c; }
    .Bodily-kinesthetic { background-color: #22c55e; color: #1b4b27; }
    .Interpersonal { background-color: #facc15; color: #4b4700; }
    .Intrapersonal { background-color: #c084fc; color: #3f2b73; }
    .Naturalistic { background-color: #10b981; color: #0b3f28; }
    /* Aliases for new backend intelligence types */
    .verbal-linguistic { background-color: #a78bfa; color: #1e1b4b; }
    .visual-spatial { background-color: #3b82f6; color: #0b2447; }
    .musical-rhythmic { background-color: #ef4444; color: #4b1c1c; }

    .card-title {
      font-size: 1.1rem;
      font-weight: 700;
      color: #67e8f9;
      margin-bottom: 12px;
    }
    .card-description {
      flex-grow: 1;
      font-size: 0.9rem;
      line-height: 1.3;
      margin-bottom: 15px;
      white-space: pre-line;
      color: white;
    }

    /* Buttons container */
    .card-buttons {
      display: flex;
      gap: 12px;
    }
    button {
      cursor: pointer;
      background: #06b6d4;
      border: none;
      border-radius: 9999px;
      padding: 8px 14px;
      color: white;
      font-weight: 600;
      font-size: 0.9rem;
      transition: background 0.2s;
      user-select: none;
    }
    button:hover:not(:disabled) {
      background: #0891b2;
    }
    button:disabled {
      background: rgba(6, 182, 212, 0.4);
      cursor: not-allowed;
    }

    /* Bottom buttons row */
    .bottom-buttons {
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .refresh-all {
      background: #06b6d4;
      font-weight: 700;
      padding: 12px 24px;
      border-radius: 9999px;
      user-select: none;
    }
    .refresh-all:hover {
      background: #0891b2;
    }
    .next-btn {
      background: #06b6d4;
      font-weight: 700;
      padding: 12px 24px;
      border-radius: 9999px;
      user-select: none;
      transition: background 0.2s;
    }
    .next-btn:hover:not(:disabled) {
      background: #0891b2;
    }
    .next-btn:disabled {
      background: rgba(6, 182, 212, 0.4);
      cursor: not-allowed;
    }
  </style>
</head>
<body>
  <div class="container" role="main" aria-label="Step 3 Formative Task Selection">
      <button id="generateAiBtn" type="button" style="margin-bottom: 20px; background: #22c55e;">
        ü§ñ Generate with AI
      </button>

    <h1>‚úÖ Step 3: Select Formative Tasks</h1>
    <p id="descriptionText" class="description">
      <!-- Filled by JS -->
    </p>

    <div id="warning" class="warning" style="display:none;">
      ‚ö†Ô∏è You have selected fewer than the recommended number of tasks.
    </div>

    <div class="cards-grid" id="cardsGrid" aria-live="polite" aria-relevant="additions removals">
      <!-- Cards inserted by JS -->
    </div>

    <div class="bottom-buttons">
      <button id="refreshAllBtn" class="refresh-all" type="button" disabled>üîÑ Refresh Unselected</button>
      <button id="nextBtn" class="next-btn" type="button" disabled>Next ‚û°Ô∏è</button>
    </div>
  </div>

  <script>
  let maxSelectable = 3; // default fallback

  try {
    const lessonData = JSON.parse(localStorage.getItem('lessonData') || '{}');
    const parsed = parseInt(lessonData.formativeTasks, 10);
    if (!isNaN(parsed)) {
      maxSelectable = parsed;
    }
  } catch (e) {
    console.warn('Could not parse lessonData for formativeTasks:', e);
  }
  console.log('maxSelectable loaded from lessonData:', maxSelectable);

  let tasks = [];

  const cardsGrid = document.getElementById('cardsGrid');
  const warningDiv = document.getElementById('warning');
  const nextBtn = document.getElementById('nextBtn');
  const refreshAllBtn = document.getElementById('refreshAllBtn');
  const generateAiBtn = document.getElementById('generateAiBtn');
  const descriptionText = document.getElementById('descriptionText');
  descriptionText.textContent = `Choose up to ${maxSelectable} formative tasks. Each lasts 2‚Äì5 minutes and offers a different way to understand the topic.`;

  function renderCards() {
    cardsGrid.innerHTML = '';
    tasks.forEach(task => {
      const card = document.createElement('div');
      card.className = 'card' + (task.selected ? ' selected' : '');
      card.tabIndex = 0;
      card.setAttribute('role', 'button');
      card.setAttribute('aria-pressed', task.selected ? 'true' : 'false');
      card.setAttribute('aria-label', `${task.title}, ${task.type} formative task`);

      card.addEventListener('click', () => {
        toggleSelectTask(task.id);
      });

      card.addEventListener('keydown', e => {
        if (e.key === 'Enter' || e.key === ' ') {
          e.preventDefault();
          toggleSelectTask(task.id);
        }
      });

      const label = document.createElement('div');
      label.className = 'card-label ' + task.type;
      label.textContent = task.type;
      card.appendChild(label);

      const title = document.createElement('div');
      title.className = 'card-title';
      title.textContent = task.title;
      card.appendChild(title);

      const desc = document.createElement('div');
      desc.className = 'card-description';
      desc.textContent = task.description;
      card.appendChild(desc);
      
      cardsGrid.appendChild(card);
    });

    updateWarningAndNext();
  }

  function toggleSelectTask(id) {
    const idx = tasks.findIndex(t => t.id === id);
    if (idx === -1) return;

    if (tasks[idx].selected) {
      tasks[idx].selected = false;
    } else {
      if (tasks.filter(t => t.selected).length >= maxSelectable) return;
      tasks[idx].selected = true;
    }
    renderCards();
  }
  
  function setLoadingState(loading) {
      generateAiBtn.disabled = loading;
      refreshAllBtn.disabled = loading;
      if(loading) {
        cardsGrid.innerHTML = '<p style="text-align:center; color:#67e8f9;">Generating tasks with AI...</p>';
      }
      updateWarningAndNext();
  }

  async function refreshAllTasks() {
    setLoadingState(true);

    try {
        const selectedTasks = tasks.filter(t => t.selected);
        const newTasksResponse = await fetchMultipleAiGeneratedTasks();

        const selectedTitles = new Set(selectedTasks.map(t => t.title));
        const filteredNewTasks = newTasksResponse.filter(t => !selectedTitles.has(t.title));

        const needed = 8 - selectedTasks.length;
        const newUnselectedTasks = filteredNewTasks.slice(0, needed > 0 ? needed : 0);

        newUnselectedTasks.forEach((t, index) => {
            t.id = `task-${index + selectedTasks.length}-${Date.now()}`;
        });

        tasks = [...selectedTasks, ...newUnselectedTasks];
        renderCards();
    } catch (e) {
      cardsGrid.innerHTML = '<p style="color:#f87171; text-align:center;">Failed to generate tasks. Please try again.</p>';
      console.error("Refresh failed:", e);
    } finally {
      setLoadingState(false);
    }
  }
  
  // Implemented using fetch with text/plain to avoid CORS issues, as per notes.
  async function fetchMultipleAiGeneratedTasks() {
      const lessonData = JSON.parse(localStorage.getItem('lessonData') || '{}');
      
      const sanitizedLessonData = {
          subject: lessonData.subject || "",
          courseLevel: lessonData.courseLevel || "",
          lessonTitle: lessonData.lessonTitle || "",
          lessonEssentials: lessonData.lessonEssentials || "",
          resources: lessonData.resources || { computer: false, internet: false, penPaper: false, more: "" }
      };

      const payload = {
          type: "initial_formative_generation",
          lessonData: sanitizedLessonData
      };
      
      const BACKEND_URL = "https://script.google.com/macros/s/AKfycbzyl5Sxko6e1lq-cgaBJyW8k4rUVkAV07nRX9_6k3VUsCv9V2q5bwlyXgtOclwmqXrK/exec";

      try {
          const response = await fetch(BACKEND_URL, {
              method: 'POST',
              mode: 'cors',
              headers: {
                  'Content-Type': 'text/plain;charset=utf-8',
              },
              body: JSON.stringify(payload),
              redirect: 'follow'
          });

          if (!response.ok) {
              throw new Error(`HTTP error! status: ${response.status}`);
          }

          let responseText = await response.text();
          
          // Clean up potential markdown code blocks from the response
          responseText = responseText.trim().replace(/^```json\s*/, '').replace(/\s*```$/, '');

          const data = JSON.parse(responseText);

          // The backend could return a raw array or an object with a result property.
          const tasksArray = Array.isArray(data) ? data : data.result;

          if (!Array.isArray(tasksArray)) {
              console.error("Backend Error:", data.error || "Response is not a valid array of tasks.");
              throw new Error("AI did not return a valid list of tasks.");
          }
          
          return tasksArray.map((item, index) => ({
              id: `task-${index + 1}-${Date.now()}`,
              title: item.title,
              type: item.intelligenceType,
              description: item.description,
              selected: false
          }));

      } catch (error) {
          console.error("fetchMultipleAiGeneratedTasks failure:", error);
          throw new Error(`Failed to communicate with backend: ${error.message}`);
      }
  }

  function updateWarningAndNext() {
    const selectedCount = tasks.filter(t => t.selected).length;
    warningDiv.style.display = selectedCount < maxSelectable && selectedCount > 0 && tasks.length > 0 ? 'block' : 'none';
    nextBtn.disabled = selectedCount === 0;
    refreshAllBtn.disabled = tasks.length === 0 || generateAiBtn.disabled;
  }

  generateAiBtn.addEventListener('click', async () => {
    setLoadingState(true);
    
    try {
      const lessonData = JSON.parse(localStorage.getItem('lessonData') || '{}');
      const parsed = parseInt(lessonData.formativeTasks, 10);
      if (!isNaN(parsed)) {
        maxSelectable = parsed;
        const descriptionText = document.getElementById('descriptionText');
        if (descriptionText) {
          descriptionText.textContent = `Choose up to ${maxSelectable} formative tasks. Each lasts 2‚Äì5 minutes and offers a different way to understand the topic.`;
        }
      }
    } catch (e) {
      console.warn('Could not parse lessonData for formativeTasks:', e);
    }

    try {
      tasks = await fetchMultipleAiGeneratedTasks(); // Fetches 8 by default
      renderCards();
    } catch (e) {
      cardsGrid.innerHTML = '<p style="color:#f87171; text-align:center;">Failed to generate tasks. Please try again.</p>';
      console.error("Generation failed:", e);
    } finally {
      setLoadingState(false);
    }
  });

  refreshAllBtn.addEventListener('click', refreshAllTasks);

  nextBtn.addEventListener('click', () => {
    const selected = tasks.filter(t => t.selected).map(t => ({
      title: t.title,
      description: t.description,
      label: t.type
    }));

    localStorage.setItem('selectedFormative', JSON.stringify(selected));

    alert('Selected tasks have been saved. Proceeding to the next step.\n' + JSON.stringify(selected, null, 2));
  });

  renderCards();
</script>

</body>
</html>