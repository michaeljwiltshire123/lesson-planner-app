<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Step 5 - Add Media</title>
  <style>
  #image-paste-area {
    display: none; /* Hide by default */
  }

  .navigation-controls {
      display: flex;
      justify-content: center;
      align-items: center;
      gap: 12px;
      margin-top: 20px;
  }
  /* [styles unchanged] */

  .slide-card {
    background: rgba(255, 255, 255, 0.08);
    border: 1px solid #38bdf8;
    border-radius: 14px;
    padding: 20px;
    margin-bottom: 20px;
    text-align: center;
    color: #67e8f9;
    cursor: pointer;
  }

  .bottom-nav {
    width: 100%;
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 15px;
    margin-top: 40px;
  }
  
  #slide-footer-info {
    color: #94a3b8;
    font-size: 0.9rem;
    text-align: center;
  }

  .nav-buttons-container {
      display: flex;
      justify-content: center;
      gap: 20px;
  }

  .navigation-controls button,
  .navigation-controls select {
    font-size: 0.9rem;
    padding: 8px 24px;
    border-radius: 9999px; /* nice rounded corners */
  }


  body {
    margin: 0;
    font-family: 'Segoe UI', sans-serif;
    background: linear-gradient(145deg, #0f172a, #1e293b);
    color: white;
    padding: 20px;
  }
  .container {
    max-width: 900px;
    margin: auto;
    background: rgba(255, 255, 255, 0.05);
    border: 1px solid rgba(255, 255, 255, 0.15);
    border-radius: 20px;
    padding: 30px;
    box-shadow: 0 0 30px rgba(0, 255, 255, 0.1);
    backdrop-filter: blur(10px);
  }
  h1 {
    text-align: center;
    color: #67e8f9;
    font-size: 2rem;
    margin-bottom: 10px;
  }
  .tab-buttons {
    display: flex;
    flex-wrap: wrap;
    gap: 10px;
    justify-content: center;
    margin: 20px 0;
    border-bottom: 1px solid #334155;
    padding-bottom: 20px;
  }
  .tab-button {
    background: transparent;
    color: #e0f2fe;
    border: none;
    padding: 10px 20px;
    border-radius: 8px;
    font-size: 0.95rem;
    font-weight: bold;
    cursor: pointer;
    transition: background-color 0.2s, color 0.2s;
    text-decoration: none;
    display: inline-block;
    border: 2px solid transparent;
  }
  
  .tab-buttons .tab-button {
    border-bottom: 3px solid transparent;
    border-radius: 6px 6px 0 0;
    padding: 10px 15px;
    color: #94a3b8;
    background-color: transparent;
  }
  
  .tab-buttons .tab-button:hover:not(.active) {
    background-color: rgba(255, 255, 255, 0.05);
    border-bottom-color: #38bdf8;
    color: white;
  }

  .tab-buttons .tab-button.active {
    background-color: rgba(6, 182, 212, 0.1);
    color: white;
    border-bottom-color: #06b6d4;
  }

  .tab-button:disabled {
    opacity: 0.5;
    cursor: not-allowed;
  }
  
  .action-button {
    background: #06b6d4;
    color: white;
    border: none;
    padding: 10px 20px;
    border-radius: 9999px;
    font-size: 0.95rem;
    font-weight: bold;
    cursor: pointer;
    transition: background 0.2s;
  }
  
  .action-button:hover:not(:disabled) {
    background: #0891b2;
  }
  
  iframe {
    width: 100%;
    height: 600px;
    border: none;
    margin-bottom: 20px;
    border-radius: 12px;
  }
  .media-inputs {
    margin-bottom: 20px;
    display: flex;
    flex-wrap: wrap;
    gap: 10px;
    align-items: center;
  }
  .media-inputs input[type="text"] {
    flex-grow: 1;
    min-width: 200px;
    padding: 10px;
    border-radius: 10px;
    border: 1px solid #38bdf8;
    background: rgba(255, 255, 255, 0.07);
    color: white;
  }
  .media-inputs button {
    padding: 10px 20px;
    background: #06b6d4;
    border: none;
    border-radius: 9999px;
    color: white;
    font-weight: bold;
    cursor: pointer;
  }
  .media-inputs input[type="file"] {
    color: white;
  }
  .preview-container {
    margin-top: 20px;
  }
  .preview-container h3 {
    margin-bottom: 10px;
    color: #67e8f9;
  }
  .remove-btn {
    position: absolute;
    top: 6px;
    right: 6px;
    background: #ef4444;
    color: white;
    border: none;
    border-radius: 50%;
    width: 25px;
    height: 25px;
    cursor: pointer;
    font-weight: bold;
    line-height: 22px;
    text-align: center;
    user-select: none;
    z-index: 20;
  }
  .remove-btn:hover {
    background: #b91c1c;
  }
  .instruction-box {
    background-color: rgba(255, 255, 255, 0.1);
    border: 1px solid #38bdf8;
    padding: 15px;
    border-radius: 12px;
    margin-bottom: 15px;
    color: #bae6fd;
    font-size: 0.95rem;
  }
  .navigation-controls select {
    background: #06b6d4;
    color: white;
    border: none;
    padding: 10px 18px;
    border-radius: 9999px;
    font-weight: bold;
    cursor: pointer;
  }
  .navigation-controls select:focus {
    outline: none;
    box-shadow: 0 0 5px #38bdf8;
  }
  #video-search-btn {
    margin-top: 15px;
    margin-bottom: 20px;
    text-align: center;
  }
  @media (max-width: 600px) {
    iframe {
      height: 300px;
    }
    .main-preview-area {
        height: 250px;
    }
  }
  .top-sync-container {
  text-align: center;
  margin: 20px 0;
  }

  #syncBtn {
    font-size: 0.9rem;
    padding: 8px 24px;
    border-radius: 9999px;
    display: inline-block;
    cursor: pointer;
    background-color: #0ea5e9;
    color: white;
    border: none;
  }
  #ai-image-prompts {
  color: #fff;
  background-color: rgba(0, 0, 0, 0.1);
  border-radius: 12px;
  padding: 20px;
  max-width: 800px;
  margin: auto;
  }

  .prompt-controls {
  display: flex;
  flex-wrap: wrap;
  gap: 20px;
  margin-bottom: 20px;
  }

  .prompt-controls label {
  display: flex;
  flex-direction: column;
  font-weight: bold;
  font-size: 14px;
  color: #67e8f9;
  }

  .prompt-templates {
  margin-top: 20px;
  }

  .prompt-box {
  background: rgba(255, 255, 255, 0.05);
  border: 1px solid #38bdf8;
  border-radius: 10px;
  padding: 10px;
  margin-bottom: 12px;
  position: relative;
  }

  .prompt-preview {
  margin: 6px 0 0;
  color: #e0f2fe;
  font-size: 15px;
  user-select: all; /* Make text easily selectable */
  }
  
  .ai-image-tools a.tab-button {
    flex: 1 1 200px;
    text-align: center;
    padding: 10px 12px;
    background-color: #0ea5e9;
    border: none;
    color: white;
    border-radius: 8px;
    text-decoration: none;
    font-weight: 600;
    transition: background 0.3s;
  }

  .ai-image-tools a.tab-button:hover {
    background-color: #0284c7;
  }

  /* New Media Previewer Styles */
  .main-preview-area {
    width: 100%;
    height: 350px;
    background: #0f172a;
    border: 1px solid #38bdf8;
    border-radius: 14px;
    display: flex;
    align-items: center;
    justify-content: center;
    margin-bottom: 20px;
    overflow: hidden;
  }

  .main-preview-area img,
  .main-preview-area video,
  .main-preview-area iframe {
    max-width: 100%;
    max-height: 100%;
    width: auto;
    height: auto;
    object-fit: contain;
    border: none;
    border-radius: 12px;
  }

  .thumbnail-strip-container {
    width: 100%;
    overflow-x: auto;
    padding-bottom: 10px; /* For scrollbar visibility */
    border-top: 1px solid #38bdf8;
    margin-top: 20px;
    padding-top: 15px;
  }

  .thumbnail-strip {
    display: flex;
    flex-wrap: nowrap;
    gap: 10px;
    padding: 5px;
    min-width: min-content; /* Allows the flex container to grow */
  }

  .thumbnail-item {
    width: 120px;
    height: 80px;
    flex-shrink: 0;
    border: 3px solid transparent;
    border-radius: 8px;
    cursor: pointer;
    position: relative;
    overflow: hidden;
    background-color: #1e293b;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: border-color 0.3s;
  }

  .thumbnail-item:hover {
    border-color: #67e8f9;
  }

  .thumbnail-item.active {
    border-color: #06b6d4;
    box-shadow: 0 0 10px #06b6d4;
  }

  .thumbnail-item img,
  .thumbnail-item video {
    width: 100%;
    height: 100%;
    object-fit: cover;
    pointer-events: none; /* Prevent interaction with thumbnail media */
  }

  /* Re-using the remove-btn style for thumbnails */
  .thumbnail-item .remove-btn {
    position: absolute;
    top: 4px;
    right: 4px;
    width: 20px;
    height: 20px;
    font-size: 14px;
    line-height: 18px;
    opacity: 0.8;
  }
   .thumbnail-item:hover .remove-btn {
    opacity: 1;
   }
   
  #image-paste-area.empty::before {
    content: 'Paste an image here (Ctrl+V or right-click > Paste)';
    color: #94a3b8;
    font-style: italic;
  }
  </style>
// Import the functions you need from the SDKs you need
import { initializeApp } from "firebase/app";
import { getAnalytics } from "firebase/analytics";
// TODO: Add SDKs for Firebase products that you want to use
// https://firebase.google.com/docs/web/setup#available-libraries

// Your web app's Firebase configuration
// For Firebase JS SDK v7.20.0 and later, measurementId is optional
const firebaseConfig = {
  apiKey: "AIzaSyCLu40uiowhMWcrDjQmI1y7FZ-YjNOAlgk",
  authDomain: "best-lesson-planner.firebaseapp.com",
  projectId: "best-lesson-planner",
  storageBucket: "best-lesson-planner.firebasestorage.app",
  messagingSenderId: "211138252279",
  appId: "1:211138252279:web:fb2c5cd541fd6f6c2af2f2",
  measurementId: "G-JMSFVXSG42"
};

// Initialize Firebase
const app = initializeApp(firebaseConfig);
const analytics = getAnalytics(app);
</head>
<body>
  <div class="top-sync-container">
    <button id="syncBtn" onclick="handleSync()">Sync</button>
  </div>
  <div class="container">
    <h1>üéûÔ∏è Step 5: Add Media to Slide</h1>
    <div class="slide-card">
      <h2>Slide: "Understanding Media Bias"</h2>
    </div>
    <div class="navigation-controls">
      <button id="topPrevSlideBtn" class="action-button">‚¨ÖÔ∏è</button>
      <select id="slideSelector" onchange="selectSlide(this.value)">
        <option value="" disabled selected>
          Jump to page
        </option>
      </select>
      <button id="topNextSlideBtn" class="action-button">‚û°Ô∏è</button>
    </div>
    <div class="tab-buttons">
      <button class="tab-button active" onclick="openTab('image', this)">üîç Image Search</button>
      <button class="tab-button" onclick="openTab('gif', this)">üîç GIFs</button>
      <button class="tab-button" onclick="openTab('video', this)">üîç Videos</button>
      <button class="tab-button" onclick="openTab('ai-image', this)">üé® AI Image</button>
      <button class="tab-button" onclick="openTab('ai-video', this)">üé¨ AI Video</button>
    </div>

    <div id="ai-image-prompts" style="display: none; margin-top: 20px;">
      <h3>AI Image Prompt Generator</h3>
       <div class="instruction-box" style="font-size: 0.9em; margin-bottom: 20px;">
          <strong>Tip:</strong> Manually select and copy (Ctrl+C / Cmd+C) the generated prompt text below.
       </div>
      <div class="prompt-controls">
        <label>Type: <select id="typeSelect">
          <option value="portrait">
            Portrait
          </option>
          <option value="cartoon">
            Cartoon
          </option>
          <option value="POV">
            POV
          </option>
          <option value="landscape">
            Landscape
          </option>
          <option value="abstract">
            Abstract
          </option>
          <option value="conceptual">
            Conceptual
          </option>
        </select></label> <label>Style: <select id="styleSelect">
          <option>
            Photorealistic
          </option>
          <option>
            Digital painting
          </option>
          <option>
            3D Render
          </option>
          <option>
            Watercolor
          </option>
          <option>
            Comic-book
          </option>
        </select></label> <label>Tone: <select id="toneSelect">
          <option>
            Neutral
          </option>
          <option>
            Hopeful
          </option>
          <option>
            Serious
          </option>
          <option>
            Dramatic
          </option>
          <option>
            Optimistic
          </option>
        </select></label> <label>Perspective: <select id="perspectiveSelect">
          <option>
            Teacher
          </option>
          <option>
            Activist
          </option>
          <option>
            Historian
          </option>
          <option>
            Journalist
          </option>
          <option>
            Student
          </option>
        </select></label>
      </div>
      <div class="prompt-box">
        <strong>Regular:</strong>
        <p id="prompt-regular" class="prompt-preview">Prompt will appear here.</p>
      </div>
      <div class="prompt-box">
        <strong>Conceptual:</strong>
        <p id="prompt-conceptual" class="prompt-preview">Prompt will appear here.</p>
      </div>
      <div class="prompt-box">
        <strong>Illustrative:</strong>
        <p id="prompt-illustrative" class="prompt-preview">Prompt will appear here.</p>
      </div>
      <div class="prompt-box">
        <strong>Metaphorical:</strong>
        <p id="prompt-metaphorical" class="prompt-preview">Prompt will appear here.</p>
      </div>
      <h4 style="margin-top: 30px; margin-bottom: 10px; color: #38bdf8;">Open Free AI Image Tools</h4>
      <div class="ai-image-tools" style="margin-top: 20px; display: flex; flex-wrap: wrap; gap: 10px;">
        <a href="https://aistudio.google.com/prompts/new_image" target="_blank" class="tab-button">Gemini Image</a> <a href="https://www.meta.ai/" target="_blank" class="tab-button">Meta AI</a> <a href="https://www.bing.com/images/create" target="_blank" class="tab-button">Bing Create</a> <a href="https://www.craiyon.com/" target="_blank" class="tab-button">Craiyon</a>
      </div>
    </div>
    <div id="iframe-container">
      <iframe id="media-frame" src="" name="media-frame"></iframe>
    </div>
    <div class="instruction-box" id="tab-instructions">
      <strong>To add an image or GIF:</strong><br>
      1. Right-click the media you want.<br>
      2. Click <strong>"Copy Image Address"</strong> (or similar).<br>
      3. Paste it into the box below.<br>
      4. Or upload a file from your device.
    </div>
    <div id="video-tab-content" style="display:none">
        <div class="instruction-box" id="video-instructions">
          <strong>To add a video to your presentation:</strong><br>
          1. Click the search button below to find a video.<br>
          2. On the video page, press the share button.<br>
          3. Copy the share video link.<br>
          4. Paste the share link below and press Add.
        </div>
        <div id="video-search-btn">
          <a href="https://www.bing.com/videos/search?q=media+bias+site:youtube.com" target="_blank" class="action-button">üåê Video Search</a>
        </div>
    </div>
    <div id="ai-video-converter" style="display: none; margin-top: 20px;">
      <h3>AI Video</h3>
      <div class="instruction-box">
          <strong>How to add AI Video as a GIF:</strong><br>
          1. Use the free tools below to generate and download an MP4 video.<br>
          2. Use an online "Video to GIF" converter (e.g., <a href="https://ezgif.com/video-to-gif" target="_blank" rel="noopener noreferrer" style="color: #67e8f9;">ezgif.com</a>) to change your MP4 into a GIF file.<br>
          3. Upload your new GIF file below.
      </div>
      <div class="ai-image-tools" style="margin-top: 20px; margin-bottom: 20px; display: flex; flex-wrap: wrap; gap: 10px;">
        <a href="https://hailuoai.video/?tab-id=webVideo" target="_blank" class="tab-button">Hailuo AI (3 Free/Day)</a> 
        <a href="https://share.pix.video/referral/8PSEGBPW" target="_blank" class="tab-button">PixVerse (3 Free/Day)</a> 
        <a href="https://www.vidu.com/create/text2video" target="_blank" class="tab-button">Vidu (3 Free/Day)</a> 
        <a href="https://www.krea.ai/video" target="_blank" class="tab-button">Krea (2 Free/Day - Slow)</a>
      </div>
      <div class="media-inputs" style="justify-content: center;">
        <input type="file" id="ai-video-upload-file" accept="image/gif">
      </div>
    </div>
    <div id="image-paste-area" contenteditable="true" class="empty" style="border: 2px dashed #38bdf8; padding: 20px; text-align: center; margin-top: 10px; border-radius: 10px;">
    </div>
    <div class="media-inputs">
      <input type="text" id="media-url" placeholder="Paste media URL here"> <button class="action-button" onclick="addMediaFromUrl()">Add</button> <input type="file" id="upload-file" accept="image/*,video/*">
    </div>
    <div class="preview-container">
      <h3>Selected Media</h3>
      <!-- Main preview area for the selected media -->
      <div id="main-media-preview" class="main-preview-area">
        <!-- Selected media will be rendered here -->
      </div>
      <!-- Scrollable horizontal strip of thumbnails -->
      <div id="thumbnail-container" class="thumbnail-strip-container">
        <div id="thumbnail-strip" class="thumbnail-strip">
          <!-- Thumbnails will be rendered here -->
        </div>
      </div>
    </div>
  </div>
 
<script>
    // --- STATE MANAGEMENT ---
    let currentSlideIndex = 0;
    let slides = []; // Master list of slide objects
    let showingContent = false; // Toggles between showing title and content
    let currentTab = 'image';
    
    // Holds media for the CURRENTLY viewed slide
    let mediaItems = []; 
    // Holds media for ALL slides, keyed by original slide index
    let allMedia = {};   
    let currentMediaIndex = 0;

    // --- DOM ELEMENT REFERENCES ---
    // (Cached on DOMContentLoaded)
    const dom = {};

    // --- INITIALIZATION ---
    document.addEventListener('DOMContentLoaded', () => {
        // Cache DOM elements for performance
        Object.assign(dom, {
            slideCard: document.querySelector('.slide-card'),
            slideSelector: document.getElementById('slideSelector'),
            iframeContainer: document.getElementById('iframe-container'),
            mediaFrame: document.getElementById('media-frame'),
            tabInstructions: document.getElementById('tab-instructions'),
            videoTabContent: document.getElementById('video-tab-content'),
            videoSearchBtn: document.getElementById('video-search-btn'),
            aiImagePrompts: document.getElementById('ai-image-prompts'),
            aiVideoConverter: document.getElementById('ai-video-converter'),
            imagePasteArea: document.getElementById('image-paste-area'),
            mediaInputs: document.querySelector('.media-inputs'),
            uploadFile: document.getElementById('upload-file'),
            aiVideoUploadFile: document.getElementById('ai-video-upload-file'),
            typeSelect: document.getElementById('typeSelect'),
            styleSelect: document.getElementById('styleSelect'),
            toneSelect: document.getElementById('toneSelect'),
            perspectiveSelect: document.getElementById('perspectiveSelect'),
            mainMediaPreview: document.getElementById('main-media-preview'),
            thumbnailStrip: document.getElementById('thumbnail-strip'),
            slideFooterInfo: document.getElementById('slide-footer-info'),
            topPrevSlideBtn: document.getElementById('topPrevSlideBtn'),
            topNextSlideBtn: document.getElementById('topNextSlideBtn'),
            bottomPrevSlideBtn: document.getElementById('bottomPrevSlideBtn'),
            bottomNextSlideBtn: document.getElementById('bottomNextSlideBtn')
        });

        // Set up event listeners
        dom.uploadFile.addEventListener('change', handleFileUpload);
        dom.aiVideoUploadFile.addEventListener('change', handleFileUpload);
        dom.imagePasteArea.addEventListener('paste', handlePaste);
        dom.imagePasteArea.addEventListener('input', () => {
            // Toggle placeholder class based on content
            dom.imagePasteArea.classList.toggle('empty', dom.imagePasteArea.textContent.trim() === '');
        });

        ['typeSelect', 'styleSelect', 'toneSelect', 'perspectiveSelect'].forEach(id => {
            const el = document.getElementById(id);
            el?.addEventListener('change', updatePrompts);
        });
        
        // Navigation Listeners
        dom.topPrevSlideBtn.addEventListener('click', goToPreviousSlide);
        dom.topNextSlideBtn.addEventListener('click', goToNextSlide);
        dom.bottomPrevSlideBtn.addEventListener('click', goToPreviousSlide);
        dom.bottomNextSlideBtn.addEventListener('click', goToNextSlide);

        // Initial setup
        openTab('image', document.querySelector('.tab-buttons .tab-button'));
        handleSync();
    });

    // --- SLIDE NAVIGATION & MANAGEMENT ---
    function navigateToSlide(newIndex) {
        if (newIndex < 0 || newIndex >= slides.length) return;

        // 1. Save media for the slide we are leaving
        allMedia[currentSlideIndex] = [...mediaItems];

        // 2. Update state to new slide index
        currentSlideIndex = newIndex;
        showingContent = false;

        // 3. Load media for the new slide
        mediaItems = allMedia[currentSlideIndex] ? [...allMedia[currentSlideIndex]] : [];
        currentMediaIndex = 0;
        
        // 4. Re-render all UI components
        renderMediaPreview();
        updateSlideView();
        updateNavButtons();
    }

    function goToPreviousSlide() {
        navigateToSlide(currentSlideIndex - 1);
    }

    async function goToNextSlide() {
        if (currentSlideIndex >= slides.length - 1) {
            await saveAndContinue();
        } else {
            navigateToSlide(currentSlideIndex + 1);
        }
    }
    
    function selectSlide(indexStr) {
        const index = Number(indexStr);
        navigateToSlide(index);
        if (dom.slideSelector) dom.slideSelector.value = ""; // Reset dropdown prompt
    }

    function handleSync() {
        const data = localStorage.getItem('generatedSlides');
        if (!data) {
            alert('No slides found in localStorage. Please ensure you have generated slides in Step 1.');
            return;
        }
        try {
            slides = JSON.parse(data);
            currentSlideIndex = 0;
            showingContent = false;
            allMedia = {};
            mediaItems = [];
            currentMediaIndex = 0;
            
            updateSlideView();
            renderMediaPreview();
            updateNavButtons();
            alert('Slides synced successfully!');
        } catch (e) {
            alert('Error parsing slide data. Check console for details.');
            console.error(e);
        }
    }
    window.handleSync = handleSync; // Make accessible from HTML onclick

    // --- UI RENDERING & UPDATES ---
    function updateSlideView() {
        if (!slides.length) {
            dom.slideCard.innerHTML = '<h2>No slides found. Please Sync.</h2>';
            return;
        }
        const slide = slides[currentSlideIndex];
        if (!slide) return;

        dom.slideCard.innerHTML = showingContent ? 
            `<h2>${slide.title || 'Untitled'}</h2><p>${slide.content || ''}</p>` :
            `<h2>${slide.title || 'Untitled'}</h2>`;
        dom.slideCard.onclick = () => {
            showingContent = !showingContent;
            updateSlideView();
        };
        
        dom.slideFooterInfo.textContent = `Slide ${currentSlideIndex + 1} of ${slides.length}: ${slide.title || 'Untitled'}`;

        updateCurrentSearch();
        updatePrompts();
        updateSlideSelector();
    }
    
    function updateNavButtons() {
        if (!dom.topPrevSlideBtn || !dom.bottomNextSlideBtn) return;
        const isFirstSlide = currentSlideIndex === 0;
        const isLastSlide = currentSlideIndex >= slides.length - 1;

        // Top buttons
        dom.topPrevSlideBtn.disabled = isFirstSlide;
        dom.topNextSlideBtn.disabled = false; // Never disabled, becomes save
        dom.topNextSlideBtn.textContent = isLastSlide ? 'üíæ' : '‚û°Ô∏è';

        // Bottom buttons
        dom.bottomPrevSlideBtn.disabled = isFirstSlide;
        dom.bottomNextSlideBtn.disabled = false;
        dom.bottomNextSlideBtn.textContent = isLastSlide ? 'üíæ Save and Continue' : '‚û°Ô∏è Next Slide';
    }


    function updateSlideSelector() {
        dom.slideSelector.innerHTML = '<option value="" disabled selected>Jump to page</option>';
        slides.forEach((slide, index) => {
            const option = document.createElement('option');
            option.value = index;
            option.textContent = `Slide ${index + 1}: ${slide.title || 'Untitled'}`;
            dom.slideSelector.appendChild(option);
        });
    }

    // --- TAB & SEARCH MANAGEMENT ---
    function openTab(tabName, clickedButton) {
        currentTab = tabName;
        
        // Update active class on tab buttons
        document.querySelectorAll('.tab-buttons .tab-button').forEach(btn => btn.classList.remove('active'));
        if (clickedButton) {
            clickedButton.classList.add('active');
        }

        const panels = [
            dom.iframeContainer, dom.tabInstructions, dom.videoTabContent,
            dom.aiImagePrompts, dom.aiVideoConverter,
            dom.imagePasteArea, dom.mediaInputs
        ];
        panels.forEach(p => p && (p.style.display = 'none'));

        dom.mediaInputs.style.display = 'flex';
        
        if (tabName === 'image' || tabName === 'gif') {
            dom.iframeContainer.style.display = 'block';
            dom.tabInstructions.style.display = 'block';
            if(tabName === 'image') dom.imagePasteArea.style.display = 'block';
        } else if (tabName === 'video') {
            dom.videoTabContent.style.display = 'block';
        } else if (tabName === 'ai-video') {
            dom.aiVideoConverter.style.display = 'block';
            dom.mediaInputs.style.display = 'none'; 
        } else if (tabName === 'ai-image') {
            dom.aiImagePrompts.style.display = 'block';
            dom.imagePasteArea.style.display = 'block'; 
        }
        updateCurrentSearch();
        if(tabName === 'ai-image') updatePrompts();
    }
    window.openTab = openTab; // Make accessible from HTML
    
    function getCleanSlideTitle() {
        if (!slides.length || !slides[currentSlideIndex]) return 'media';
        let title = slides[currentSlideIndex].title || 'media';
        return title.includes(':') ? title.split(':')[1].trim() : title;
    }

    function updateCurrentSearch() {
        const title = getCleanSlideTitle();
        const encodedTitle = encodeURIComponent(title);

        if (currentTab === 'image') {
            dom.mediaFrame.src = `https://www.bing.com/images/search?q=${encodedTitle}&form=QBIR`;
        } else if (currentTab === 'gif') {
            dom.mediaFrame.src = `https://giphy.com/search/${encodedTitle}`;
        } else if (currentTab === 'video') {
            const anchor = dom.videoSearchBtn?.querySelector('a');
            if (anchor) anchor.href = `https://www.youtube.com/results?search_query=${encodedTitle}`;
        }
    }
    
    // --- MEDIA HANDLING & PREVIEW ---
    function addMediaFromUrl() {
        const urlInput = document.getElementById('media-url');
        const url = urlInput.value.trim();
        if (!url) return alert('Please enter a valid media URL.');

        mediaItems.push({ type: 'url', src: url });
        urlInput.value = '';
        currentMediaIndex = mediaItems.length - 1; 
        renderMediaPreview();
    }
    window.addMediaFromUrl = addMediaFromUrl;

    function handleFileUpload(e) {
        if (e.target.files.length === 0) return;
        for (const file of e.target.files) {
            const src = URL.createObjectURL(file);
            mediaItems.push({ type: 'file', src, name: file.name, file });
        }
        currentMediaIndex = mediaItems.length - 1; 
        renderMediaPreview();
        e.target.value = ''; // Reset input
    }
    
    function handlePaste(event) {
        const items = (event.clipboardData || event.originalEvent.clipboardData).items;
        for (const item of items) {
            if (item.type.startsWith('image/')) {
                event.preventDefault();
                const blob = item.getAsFile();
                if (!blob) continue;
                const src = URL.createObjectURL(blob);
                mediaItems.push({ type: 'file', src, name: 'pasted-image.png', file: blob });
                currentMediaIndex = mediaItems.length - 1;
                renderMediaPreview();
                return;
            }
        }
    }
    
    function createMediaElement(item, isMainPreview) {
        let mediaElement;
        const src = item.src || '';
        const type = item.file ? item.file.type : '';
        const isYouTube = (s) => s.includes('youtube.com/') || s.includes('youtu.be/');
        const isGoogleDrive = (s) => s.includes('drive.google.com/file/d/');

        if (src.match(/\.(mp4|webm|ogg)$/i) || type.startsWith('video/')) {
            mediaElement = document.createElement('video');
            mediaElement.src = src;
            mediaElement.muted = !isMainPreview;
            mediaElement.loop = true;
            if (isMainPreview) {
                mediaElement.controls = true;
                mediaElement.autoplay = true;
            } else {
                mediaElement.autoplay = true; // For thumbnail animation
            }
        } else if (isYouTube(src)) {
            const videoId = src.match(/(?:youtube\.com\/(?:watch\?v=|shorts\/)|youtu\.be\/)([^&?#]+)/);
            if (isMainPreview && videoId) {
                mediaElement = document.createElement('iframe');
                mediaElement.src = `https://www.youtube.com/embed/${videoId[1]}`;
                mediaElement.allow = 'accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture';
                mediaElement.setAttribute('frameborder', '0');
            } else { // Thumbnail
                mediaElement = document.createElement('img');
                mediaElement.src = videoId ? `https://i.ytimg.com/vi/${videoId[1]}/mqdefault.jpg` : '';
            }
        } else if (isGoogleDrive(src)) {
            const driveId = src.match(/\/d\/(.+?)\//);
            if (isMainPreview && driveId) {
                mediaElement = document.createElement('iframe');
                mediaElement.src = `https://drive.google.com/file/d/${driveId[1]}/preview`;
                mediaElement.setAttribute('frameborder', '0');
            } else { // Thumbnail
                mediaElement = document.createElement('div');
                mediaElement.textContent = 'G-Drive';
                mediaElement.style.cssText = 'color: white; font-size: 12px; text-align: center;';
            }
        } else { // Default to image
            mediaElement = document.createElement('img');
            mediaElement.src = src;
            mediaElement.onerror = () => {
                mediaElement.src = `data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 200 120'%3E%3Crect width='200' height='120' fill='%231e293b'/%3E%3Ctext x='50%' y='50%' fill='%2394a3b8' font-family='sans-serif' font-size='12' dy='.3em' text-anchor='middle'%3EInvalid Media%3C/text%3E%3C/svg%3E`;
            }
        }
        return mediaElement;
    }

    function renderMediaPreview() {
        dom.mainMediaPreview.innerHTML = '';
        dom.thumbnailStrip.innerHTML = '';

        if (mediaItems.length === 0) {
            dom.mainMediaPreview.innerHTML = '<p style="color: #94a3b8;">No media selected for this slide.</p>';
            return;
        }

        currentMediaIndex = Math.max(0, Math.min(currentMediaIndex, mediaItems.length - 1));
        
        if (mediaItems[currentMediaIndex]) {
            const mediaElement = createMediaElement(mediaItems[currentMediaIndex], true);
            dom.mainMediaPreview.appendChild(mediaElement);
        }

        mediaItems.forEach((item, idx) => {
            const thumbDiv = document.createElement('div');
            thumbDiv.className = 'thumbnail-item';
            if (idx === currentMediaIndex) thumbDiv.classList.add('active');

            thumbDiv.appendChild(createMediaElement(item, false));
            thumbDiv.onclick = () => {
                currentMediaIndex = idx;
                renderMediaPreview();
            };

            const removeBtn = document.createElement('button');
            removeBtn.className = 'remove-btn';
            removeBtn.textContent = '√ó';
            removeBtn.onclick = (e) => {
                e.stopPropagation();
                mediaItems.splice(idx, 1);
                renderMediaPreview(); 
            };
            thumbDiv.appendChild(removeBtn);
            dom.thumbnailStrip.appendChild(thumbDiv);
        });

        const activeThumbnail = dom.thumbnailStrip.querySelector('.active');
        activeThumbnail?.scrollIntoView({ behavior: 'smooth', block: 'nearest', inline: 'center' });
    }

    // --- SAVE LOGIC ---
    async function saveAndContinue() {
        dom.bottomNextSlideBtn.disabled = true;
        dom.bottomNextSlideBtn.textContent = 'üíæ Saving...';

        // Save media for the current (last) slide before processing.
        allMedia[currentSlideIndex] = [...mediaItems];

        const finalSlides = [];
        const originalSlides = JSON.parse(JSON.stringify(slides)); // Deep copy

        const fileToDataUrl = (file) => {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onloadend = () => resolve(reader.result);
                reader.onerror = reject;
                reader.readAsDataURL(file);
            });
        };

        for (const [index, originalSlide] of originalSlides.entries()) {
            const mediaForThisSlide = allMedia[index] || [];
            const baseSlide = { ...originalSlide };
            delete baseSlide.media; // Ensure no old media data exists

            if (mediaForThisSlide.length === 0) {
                finalSlides.push(baseSlide);
                continue;
            }

            // Convert all file-based media to data URLs before chunking
            const processedMediaForThisSlide = await Promise.all(
                mediaForThisSlide.map(async (item) => {
                    if (item.file && item.src.startsWith('blob:')) {
                        try {
                            const dataUrl = await fileToDataUrl(item.file);
                            return { ...item, src: dataUrl }; // return new item with data: url
                        } catch (error) {
                            console.error("Failed to convert file to data URL", error);
                            return item; // fallback to original item on error
                        }
                    }
                    return item; // Not a file or already a data: URL, return as is
                })
            );
            
            const mediaChunks = [];
            for (let i = 0; i < processedMediaForThisSlide.length; i += 2) {
                mediaChunks.push(processedMediaForThisSlide.slice(i, i + 2));
            }

            baseSlide.media = mediaChunks.shift().map(item => item.src);
            finalSlides.push(baseSlide);
            
            mediaChunks.forEach(chunk => {
                finalSlides.push({
                    title: originalSlide.title, // Same title as parent
                    content: '', // New slides for media have no content
                    media: chunk.map(item => item.src)
                });
            });
        }

        try {
            localStorage.setItem('generatedSlides', JSON.stringify(finalSlides));
            alert(`Slides and media saved successfully! Your presentation now has ${finalSlides.length} slides.`);
            
            slides = finalSlides;
            allMedia = {};
            
            navigateToSlide(currentSlideIndex);
            
        } catch (e) {
            alert('Error saving slides to local storage.');
            console.error('Failed to save slides:', e);
        } finally {
             updateNavButtons();
        }
    }

    // --- AI IMAGE PROMPT GENERATOR ---
    function updatePrompts() {
        if (!slides || !slides[currentSlideIndex]) return;
        const cleanTitle = getCleanSlideTitle();
        const type = dom.typeSelect?.value || "portrait";
        const style = dom.styleSelect?.value || "Photorealistic";
        const tone = dom.toneSelect?.value || "Neutral";
        const perspective = dom.perspectiveSelect?.value || "Teacher";

        document.getElementById('prompt-regular').textContent = `A ${style} ${type} illustrating "${cleanTitle}". It should have a ${tone} tone, from a ${perspective}'s viewpoint.`;
        document.getElementById('prompt-conceptual').textContent = `A conceptual, ${style} ${type} representing "${cleanTitle}", with a ${tone} mood, seen through the eyes of a ${perspective}.`;
        document.getElementById('prompt-illustrative').textContent = `An illustrative ${type} for "${cleanTitle}" in a ${style} style. The scene is ${tone} and from a ${perspective}'s perspective.`;
        document.getElementById('prompt-metaphorical').textContent = `A metaphorical ${style} depiction of "${cleanTitle}" as a ${type}, capturing a ${tone} essence from a ${perspective}'s view.`;
    }
</script>
  <div class="bottom-nav">
      <div id="slide-footer-info">Slide 1 of 1: Title</div>
      <div class="nav-buttons-container">
        <button id="bottomPrevSlideBtn" class="action-button">‚¨ÖÔ∏è Back</button>
        <button id="bottomNextSlideBtn" class="action-button">‚û°Ô∏è Next Slide</button>
      </div>
  </div>
</body>
</html>